<!DOCTYPE html>
<html lang = "ko">
    <head>
        <meta charset="UTF-8">
        <title>EV ì¶©ì „ í˜ì´ì§€</title>
        <link rel="stylesheet" href = "{{url_for('static', filename = 'style.css')}}">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <div class = "Top">
            <header>
                <h2>EV ì¶©ì „ ëª¨ë‹ˆí„°ë§</h2>
            </header>
        </div>
        <div class="Midtop" style="display: flex; flex-wrap: wrap;">
            <section class="Leftgroup" style="flex: 0 0 350px;">
                <h3>ì°¨ëŸ‰ ì •ë³´</h3>
                <p>ì°¨ëŒ€ë²ˆí˜¸ : {{info.VIN}}</p>
                <p>ì°¨ì¢… : {{info.Model}}</p>
                <p>ì—°ê²° ìœ ë¬´ : {{info.Connect}}</p>
                <p>ìƒíƒœ : {{datas}}</p>
                <div class="BatteryStatus">
                    <h4>ë°°í„°ë¦¬ ìƒíƒœ</h4>
                    <div class="battery-circle">
                        <span class="battery-percent"><span id="soc">{{data.SOC}}</span>%</span>
                    </div>
                    <div class="battery-bar">
                        <label for="battery-level">ì¶©ì „ ìƒíƒœ</label>
                        <progress id="soh" value={{data.SOH}} max="100"></progress>
                        <h4>ë°°í„°ë¦¬ ê±´ê°•</h4>
                        <canvas id="Timer" width="100" height="45"></canvas>
                    </div>
                </div>
            </section>
            <div class="Rightgroup" style="flex: 1; min-width: 200px;">
                <section class = "BtnRightTop">
                    <form id="startForm" method="POST" action="/start"><button type="submit" id="startbtn">ì¶©ì „ ì‹œì‘</button></form>
                    <form id="stopForm" method="POST" action="/stop"><button type="submit" id="stopbtn">ì¶©ì „ ì¤‘ë‹¨</button></form>
                    <form id="cnntForm" method="POST" action="/connector"><button type = "submit" id = "cnntbtn">ì»¤ë„¥í„° ì—°ê²°</button></form>
                    <form id="mov_moniter" method="POST" action="/monitor"><button type = "submit" id = "mntbtn">ëª¨ë‹ˆí„°ë§ ì´ë™</button></form>
                </section>
                <section class="RightTopbottom">
                    <div class = "chart_set">
                        <h4>í˜„ì¬ ì°¨ëŸ‰ ì˜¨ë„: <span id="temp">{{data.Temp}}</span>Â°C</h4>
                        <canvas id="Temper" width="100" height="20"></canvas>
                    </div>
                    <div class="BatteryVoltage">
                        <h4>ë°°í„°ë¦¬ ì „ì••: <span id="volt">{{data.Voltage}}</span>V</h4>
                        <div class="battery-voltage-value">
                            <canvas id="Volt" width="100" height="20"></canvas>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </body>
    <script>
    //ì°¨íŠ¸ --------------------------------------------------------------------
    var chartArea = document.getElementById('Temper').getContext('2d');
    var Tempchart = new Chart(chartArea, {
        type: 'line',
        data: {
                labels: [],
                //ì‹¤ì œ ì°¨íŠ¸ì— í‘œì‹œí•  ë°ì´í„°
                datasets: [{
                    //datasetì˜ ì´ë¦„
                    label: 'Temperature',
                    //datasetê°’
                    data: [],
                    //ë°°ê²½ìƒ‰
                    backgroundColor: 'rgba(255, 30, 30, 0.2)',
                    //ì„  ìƒ‰
                    borderColor: 'rgba(255, 0, 0, 1)',
                    //ì„  ë‘ê»˜
                    borderWidth: 3
                }]
            },//ì°¨íŠ¸ì˜ ì„¤ì •(Object)
            options: { //ì¶•ì— ê´€í•œ ì„¤ì •(Object)
                scales: {
                    y: { //yì¶•ì— ëŒ€í•œ ì„¤ì •(Object)
                        beginAtZero: true,
                        max: 50
                    }
                }
            }
    });

    var chartArea2 = document.getElementById('Volt').getContext('2d');
    var Voltchart = new Chart(chartArea2, {
        type: 'line',
        data: {
                labels: [],
                //ì‹¤ì œ ì°¨íŠ¸ì— í‘œì‹œí•  ë°ì´í„°
                datasets: [{
                    //datasetì˜ ì´ë¦„
                    label: 'Voltage',
                    //datasetê°’
                    data: [],
                    //ë°°ê²½ìƒ‰
                    backgroundColor: 'rgba(255, 200, 0, 0.2)',
                    //ì„  ìƒ‰
                    borderColor: 'rgba(255, 150, 30, 1)',
                    //ì„  ë‘ê»˜
                    borderWidth: 3
                }]
            },//ì°¨íŠ¸ì˜ ì„¤ì •(Object)
            options: { //ì¶•ì— ê´€í•œ ì„¤ì •(Object)
                scales: {
                    y: { //yì¶•ì— ëŒ€í•œ ì„¤ì •(Object)
                        beginAtZero: true,
                        min:300,
                        max:1000
                    }
                }
            }
    });


    var chartArea3 = document.getElementById('Timer').getContext('2d');
    var Timechart = new Chart(chartArea3, {
        type: 'line',
        data: {
                labels: [],
                //ì‹¤ì œ ì°¨íŠ¸ì— í‘œì‹œí•  ë°ì´í„°
                datasets: [{
                    //datasetì˜ ì´ë¦„
                    label: 'Time',
                    //datasetê°’
                    data: [],
                    //ë°°ê²½ìƒ‰
                    backgroundColor: 'rgba(0, 255, 50, 0.2)',
                    //ì„  ìƒ‰
                    borderColor: 'rgba(0, 255, 50, 1)',
                    //ì„  ë‘ê»˜
                    borderWidth: 3
                }]
            },//ì°¨íŠ¸ì˜ ì„¤ì •(Object)
            options: { //ì¶•ì— ê´€í•œ ì„¤ì •(Object)
                scales: {
                    y: { //yì¶•ì— ëŒ€í•œ ì„¤ì •(Object)
                        beginAtZero: true,
                    }
                }
            }
    });
    //ì°¨íŠ¸ --------------------------------------------------------------------

    function fetchData() {
        fetch('/update/data')  // JSONì„ ë°˜í™˜í•˜ëŠ” ìƒˆ ê²½ë¡œ
            .then(response => response.json())
            .then(data => {
                document.getElementById('soc').textContent = data.SOC;
                const sohValue = parseFloat(data.SOH);
                document.getElementById('soh').value = isFinite(sohValue) ? sohValue : 0;
                document.getElementById('temp').textContent = data.Temp;
                document.getElementById('volt').textContent = data.Voltage;
                //document.getElementById('Temper').textContent = data.Temp;
                var now = new Date().toLocaleTimeString();
                if (Tempchart.data.labels.length >= 10) {
                    Tempchart.data.labels.shift();
                    Tempchart.data.datasets[0].data.shift();
                }
                Tempchart.data.labels.push(now);
                Tempchart.data.datasets[0].data.push(data.Temp);
                if(Voltchart.data.labels.length >= 10){
                    Voltchart.data.labels.shift();
                    Voltchart.data.datasets[0].data.shift();
                }
                Voltchart.data.labels.push(now);
                Voltchart.data.datasets[0].data.push(data.Voltage);
                Tempchart.update();
                Voltchart.update();
            })
            .catch(error => {
                console.error('SOC ê°±ì‹  ì‹¤íŒ¨:', error);
            });
    }

    function on_message(ws, message) {
        try {
            msg = JSON.parse(message);
            can_id = String(msg.id || "");
            data_list = msg.data || [];
            data_hex = data_list.map(byte => ('0' + byte.toString(16)).slice(-2)).join('');
            lst = [];
            for (let i = 0; i < data_hex.length; i += 2) {
                lst.push(data_hex.slice(i, i + 2));
            }
            chg = "";
            if (can_id in idmap) {
                chg = idmap[can_id](lst);
                console.log(`ID: ${can_id} -> ${data_hex} (${chg})`);
                console.log(`ğŸ“¤ POST ì „ì†¡ ì‹œë„: ${test_data}`);
                res = fetch("http://127.0.0.1:9359/update", {
                    method: "POST",
                    body: JSON.stringify(test_data),
                    headers: {
                        "Content-Type": "application/json"
                    }
                });
                console.log(`âœ… ì„œë²„ ì‘ë‹µ: ${res.status_code}, ë‚´ìš©: ${res.text}`);
            }
        } catch (e) {
            console.error(`Error: ${e}`);
        }
    }

    function on_error(ws, error) {
        console.error(`WebSocket error: ${error}`);
    }

    function on_close(ws, close_status_code, close_msg) {
        console.log("WebSocket connection closed");
    }

    function on_open(ws) {
        console.log("WebSocket connection established");
    }

    function run_websocket() {
        websocket.enableTrace(false);
        ws = new websocket.WebSocket("ws://127.0.0.1:12261");
        ws.onopen = on_open;
        ws.onmessage = on_message;
        ws.onerror = on_error;
        ws.onclose = on_close;
    }

    setInterval(fetchData, 500);
    </script>
</html>
